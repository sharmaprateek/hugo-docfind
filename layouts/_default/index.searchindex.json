{{- $index := slice -}} {{- range .Site.RegularPages -}}   {{- $page := . -}}   {{- $pageTitle := .Title -}}   {{- $pageUrl := .RelPermalink -}}      {{- /* 1. Split content by the START of h2 tags */ -}}   {{- $chunks := split .Content "<h2" -}}      {{- range $i, $chunk := $chunks -}}     {{- $chunkTitle := $pageTitle -}}     {{- $chunkUrl := $pageUrl -}}     {{- $chunkBody := "" -}}      {{- if eq $i 0 -}}       {{- /* CHUNK 0: The Intro (Content before the first H2) */ -}}       {{- $chunkBody = $chunk | plainify -}}          {{- else -}}       {{- /* CHUNK 1+: Content starting with an H2 tag */ -}}              {{- /* Split the chunk by the CLOSING h2 tag to isolate the header from the body */ -}}       {{- $subChunks := split $chunk "</h2>" -}}              {{- /* The first part contains attributes + Section Title (e.g. ' id="my-id">My Section') */ -}}       {{- $headerRaw := index $subChunks 0 -}}              {{- /* 1. Extract the ID */ -}}       {{- $idString := findRE `id="([^"]+)"` $headerRaw 1 -}}       {{- if gt (len $idString) 0 -}}         {{- $anchor := index $idString 0 | replaceRE `id="([^"]+)"` "$1" -}}         {{- $chunkUrl = printf "%s#%s" $pageUrl $anchor -}}       {{- end -}}        {{- /* 2. Extract the Section Title (Everything after the first '>') */ -}}       {{- $sectionName := $headerRaw | replaceRE `^[^>]+>` "" | plainify -}}       {{- $chunkTitle = printf "%s > %s" $pageTitle $sectionName -}}        {{- /* 3. Extract the Body (Everything after the </h2>) */ -}}       {{- /* We use 'after 1' and 'delimit' to handle the rare case of nested </h2> or split failures */ -}}       {{- $chunkBody = delimit (after 1 $subChunks) " " | plainify -}}     {{- end -}}      {{- /* Only add if the body has meaningful content */ -}}     {{- if gt (len $chunkBody) 10 -}}       {{- $entry := dict            "title" $chunkTitle           "href" $chunkUrl           "body" $chunkBody            "category" (index $page.Params.categories 0 | default "General")        -}}       {{- $index = $index | append $entry -}}     {{- end -}}   {{- end -}} {{- end -}} {{- $index | jsonify -}}