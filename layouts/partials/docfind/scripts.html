<script type="module">
    // Use relURL to ensure correct pathing for sub-sites
    import search, { init } from '{{ "docfind/docfind.js" | relURL }}?v={{ now.Unix }}';

    // Force initialization with fresh WASM file
    await init('{{ "docfind/docfind_bg.wasm" | relURL }}?v={{ now.Unix }}');

    /**
     * Reusable function to attach search logic to an input/results pair.
     */
    function attachSearchLogic(inputId, resultsId) {
        const input = document.getElementById(inputId);
        const resultsDiv = document.getElementById(resultsId);

        let selectedIndex = -1;

        function updateSelection() {
            const items = resultsDiv.getElementsByClassName('docfind-result-item');
            Array.from(items).forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        if (!input || !resultsDiv) return;

        input.addEventListener('keydown', (e) => {
            const items = resultsDiv.getElementsByClassName('docfind-result-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                updateSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                resultsDiv.style.display = 'none';
                input.blur();
            }
        });

        input.addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            selectedIndex = -1; // Reset selection on new input

            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                // Only hide if NOT inside a modal (modals handle visibility differently)
                // But for simplicity, we can just clear content.
                if (!resultsDiv.classList.contains('docfind-results-modal-container')) {
                    resultsDiv.style.display = 'none';
                }
                return;
            }

            try {
                const results = await search(query, 50);

                if (!results || results.length === 0) {
                    resultsDiv.innerHTML = '<div class="docfind-no-results">No results found.</div>';
                } else {
                    resultsDiv.innerHTML = results.slice(0, 10).map(r => `
                        <a href="${r.href}" class="docfind-result-item">
                            <div class="docfind-result-title">${r.title}</div>
                            <div class="docfind-result-snippet">${r.body ? r.body.substring(0, 100) + '...' : ''}</div>
                            ${r.category ? `<div class="docfind-result-category">${r.category}</div>` : ''}
                        </a>
                    `).join('');
                }
                resultsDiv.style.display = 'block';
            } catch (err) {
                console.error("DocFind search error:", err);
            }
        });

        // Hide results on click outside (General behavior)
        document.addEventListener('click', (e) => {
            const container = input.closest('.docfind-container, .docfind-widget, .docfind-modal-content');
            if (container && !container.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });

        // Show results on focus if content exists
        input.addEventListener('focus', () => {
            if (resultsDiv.innerHTML) resultsDiv.style.display = 'block';
        });
    }

    // 1. Attach to Inline Search (if exists)
    attachSearchLogic('docfind-input', 'docfind-results');

    // 2. Attach to Modal Search (if exists)
    attachSearchLogic('docfind-input-modal', 'docfind-results-modal');


    // 3. Attach to Expandable Search
    attachSearchLogic('docfind-input-expandable', 'docfind-results-expandable');

    // --- Expandable Widget Control ---
    const expWidget = document.getElementById('docfind-expandable');
    const expBtn = document.getElementById('docfind-expandable-btn');
    const expInput = document.getElementById('docfind-input-expandable');

    if (expBtn && expWidget && expInput) {
        expBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isExpanded = expWidget.classList.contains('expanded');

            if (isExpanded) {
                if (expInput.value.trim() === '') {
                    expWidget.classList.remove('expanded');
                } else {
                    expInput.focus();
                }
            } else {
                expWidget.classList.add('expanded');
                setTimeout(() => expInput.focus(), 50);
            }
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (!expWidget.contains(e.target)) {
                expWidget.classList.remove('expanded');
            }
        });
    }

    // --- Modal Control Logic ---
    const modal = document.getElementById('docfind-modal');
    const launcher = document.getElementById('docfind-launcher');
    const closeBtn = document.getElementById('docfind-close');
    const modalInput = document.getElementById('docfind-input-modal');

    function openModal() {
        if (modal) {
            modal.style.display = 'flex';
            if (modalInput) modalInput.focus();
        }
    }

    function closeModal() {
        if (modal) modal.style.display = 'none';
    }

    if (launcher) launcher.addEventListener('click', openModal);
    if (closeBtn) closeBtn.addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
        const isTyping = document.activeElement.tagName === 'INPUT' ||
            document.activeElement.tagName === 'TEXTAREA' ||
            document.activeElement.isContentEditable;

        if (e.key === 'Escape') closeModal();
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            openModal();
        }
        if (e.key === '/' && !isTyping) {
            e.preventDefault();

            // Priority 1: Open Modal if exists
            if (modal && launcher) {
                openModal();
            }
            // Priority 2: Expand Widget if exists (and no modal)
            else if (expWidget && expInput) {
                expWidget.classList.add('expanded');
                expInput.focus();
            }
            // Priority 3: Focus Inline Input
            else {
                const inlineInput = document.getElementById('docfind-input');
                if (inlineInput) inlineInput.focus();
            }
        }
    });

    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
    }
</script>